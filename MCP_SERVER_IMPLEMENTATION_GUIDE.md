\n# üåê MCP Server Implementation Guide - Yellow Box Real-Time Infrastructure\n\n## üìã **Current Status**\n- ‚úÖ MCP server architecture designed (comprehensive 599-line plan)\n- ‚úÖ Integration preparation components ready\n- ‚úÖ WebSocket and SSE specifications defined\n- ‚è≥ **NEXT STEP**: Deploy MCP server infrastructure\n\n## üéØ **MCP Server Quick Setup (30 minutes)**\n\n### **Step 1: Deploy MCP Server Core**\n```bash\n# Navigate to MCP server directory\ncd mcp-server\n\n# Install dependencies\nnpm install\n\n# Build the server\nnpm run build\n\n# Start development server\nnpm run dev\n```\n\n### **Step 2: Configure Environment**\nCreate `.env` file in `mcp-server/` directory:\n```env\n# Server Configuration\nPORT=3001\nHOST=localhost\nNODE_ENV=development\n\n# Firebase Configuration\nFIREBASE_PROJECT_ID=yellowbox-8e0e6\nFIREBASE_PRIVATE_KEY_ID=your-private-key-id\nFIREBASE_PRIVATE_KEY=\"-----BEGIN PRIVATE KEY-----\\nyour-private-key\\n-----END PRIVATE KEY-----\\n\"\nFIREBASE_CLIENT_EMAIL=your-service-account@yellowbox-8e0e6.iam.gserviceaccount.com\nFIREBASE_CLIENT_ID=your-client-id\n\n# N8N Integration\nN8N_WEBHOOK_URL=https://n8n.srv924607.hstgr.cloud/webhook/yellowbox-sync\nN8N_API_KEY=your-n8n-api-key\n\n# Security\nJWT_SECRET=your-jwt-secret-key\nCORS_ORIGINS=http://localhost:8080,https://yellowbox-8e0e6.web.app\n\n# Rate Limiting\nRATE_LIMIT_WINDOW_MS=900000\nRATE_LIMIT_MAX_REQUESTS=100\n```\n\n### **Step 3: Core Server Architecture**\n\nThe MCP server provides:\n- **WebSocket Server** (port 3001) - Real-time bidirectional communication\n- **HTTP API** - RESTful endpoints for events and health checks\n- **Server-Sent Events** - Live dashboard updates\n- **Event Router** - Intelligent message routing\n\n### **Step 4: Test MCP Server**\n```bash\n# Test server health\ncurl http://localhost:3001/health\n\n# Expected response:\n{\n  \"status\": \"healthy\",\n  \"uptime\": 12345,\n  \"connections\": {\n    \"websocket\": 0,\n    \"sse\": 0\n  },\n  \"integrations\": {\n    \"firebase\": \"connected\",\n    \"n8n\": \"connected\"\n  }\n}\n```\n\n## üîß **Integration Points**\n\n### **1. WebSocket Integration**\nUpdate your web app to connect to MCP server:\n\n```typescript\n// src/services/mcpWebSocketService.ts\nimport { io, Socket } from 'socket.io-client';\n\nexport class MCPWebSocketService {\n  private socket: Socket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 5;\n\n  connect(userId: string, userRole: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.socket = io('ws://localhost:3001', {\n        auth: {\n          userId,\n          userRole,\n          token: 'firebase-id-token'\n        }\n      });\n\n      this.socket.on('connect', () => {\n        console.log('Connected to MCP server');\n        resolve();\n      });\n\n      this.socket.on('disconnect', () => {\n        console.log('Disconnected from MCP server');\n        this.handleReconnection();\n      });\n\n      this.socket.on('connect_error', reject);\n    });\n  }\n\n  // Subscribe to real-time events\n  onRiderLocationUpdate(callback: (location: any) => void): string {\n    if (!this.socket) throw new Error('Not connected');\n    \n    this.socket.on('rider_location_update', callback);\n    return 'rider_location_subscription';\n  }\n\n  onExpenseStatusChange(callback: (expense: any) => void): string {\n    if (!this.socket) throw new Error('Not connected');\n    \n    this.socket.on('expense_status_change', callback);\n    return 'expense_status_subscription';\n  }\n}\n```\n\n### **2. Server-Sent Events for Dashboard**\n```typescript\n// src/services/mcpSSEService.ts\nexport class MCPSSEService {\n  private eventSource: EventSource | null = null;\n\n  connect(endpoint: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.eventSource = new EventSource(`http://localhost:3001/sse/${endpoint}`);\n      \n      this.eventSource.onopen = () => resolve();\n      this.eventSource.onerror = reject;\n    });\n  }\n\n  streamDashboardMetrics(callback: (metrics: any) => void): void {\n    if (!this.eventSource) throw new Error('Not connected');\n    \n    this.eventSource.addEventListener('dashboard_metrics', (event) => {\n      callback(JSON.parse(event.data));\n    });\n  }\n}\n```\n\n### **3. Event Publishing**\n```typescript\n// Publish events to MCP server\nexport const publishFleetEvent = async (eventType: string, payload: any) => {\n  const response = await fetch('http://localhost:3001/api/events', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': 'Bearer firebase-id-token'\n    },\n    body: JSON.stringify({\n      type: eventType,\n      payload,\n      priority: 'medium',\n      timestamp: new Date().toISOString()\n    })\n  });\n\n  return response.json();\n};\n```\n\n## üöÄ **Real-Time Features to Implement**\n\n### **1. Live Fleet Tracking**\n- Real-time rider GPS locations\n- Geofencing alerts\n- Route optimization suggestions\n\n### **2. Instant Notifications**\n- Expense approval/rejection\n- Document verification status\n- Emergency alerts\n\n### **3. Live Dashboard Updates**\n- Fleet metrics in real-time\n- Performance analytics\n- System health monitoring\n\n## üß™ **Testing MCP Server**\n\n### **Test 1: WebSocket Connection**\n```javascript\n// test script\nconst io = require('socket.io-client');\nconst socket = io('ws://localhost:3001');\n\nsocket.on('connect', () => {\n  console.log('‚úÖ WebSocket connected');\n  socket.emit('test_event', { message: 'Hello MCP Server' });\n});\n\nsocket.on('test_response', (data) => {\n  console.log('‚úÖ Received response:', data);\n});\n```\n\n### **Test 2: SSE Stream**\n```bash\n# Test Server-Sent Events\ncurl -N http://localhost:3001/sse/dashboard\n```\n\n### **Test 3: Event Publishing**\n```bash\n# Test event API\ncurl -X POST http://localhost:3001/api/events \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"type\": \"rider_location\",\n    \"payload\": {\n      \"riderId\": \"test-rider-001\",\n      \"latitude\": 25.2048,\n      \"longitude\": 55.2708\n    },\n    \"priority\": \"medium\"\n  }'\n```\n\n## üìä **Expected Results**\n\nAfter MCP server deployment:\n- ‚úÖ Real-time rider tracking on dashboard\n- ‚úÖ Instant expense notifications\n- ‚úÖ Live fleet metrics updates\n- ‚úÖ WebSocket connections stable\n- ‚úÖ Event routing functional\n\n## üîÑ **Production Deployment**\n\n### **Option 1: Docker Deployment**\n```bash\n# Build Docker image\ncd mcp-server\ndocker build -t yellowbox-mcp-server .\n\n# Run container\ndocker run -p 3001:3001 -d yellowbox-mcp-server\n```\n\n### **Option 2: Cloud Deployment**\n- Deploy to Google Cloud Run\n- Configure load balancing\n- Setup SSL certificates\n- Enable auto-scaling\n\n## ‚úÖ **Success Criteria**\n\nMCP server is working when:\n- [ ] Server responds to health checks\n- [ ] WebSocket connections establish successfully\n- [ ] SSE streams deliver real-time data\n- [ ] Events route correctly to subscribers\n- [ ] Firebase integration functional\n- [ ] N8N integration maintained\n\n## üéØ **Next Steps After MCP Server**\n\n1. **Activate Monitoring System** - Deploy alerting infrastructure\n2. **Test End-to-End** - Verify complete system integration\n3. **Performance Optimization** - Fine-tune real-time capabilities\n4. **Production Hardening** - Security and scaling improvements\n\n---\n\n**Priority**: üî• HIGH  \n**Time Required**: 30 minutes  \n**Dependencies**: Firebase Functions deployed  \n**Architecture**: Real-time bidirectional co