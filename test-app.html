<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YELLOWBOX Fleet Management - Full Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 3px; }
        .pass { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .summary { font-size: 18px; font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>YELLOWBOX Fleet Management - Full Test Suite</h1>
    <button onclick="runFullTest()">Run Full Test Suite</button>
    <button onclick="clearResults()">Clear Results</button>

    <div id="testResults"></div>

    <script src="data.js"></script>
    <script src="app.js"></script>

    <script>
        let testResults = [];
        let testCount = 0;
        let passCount = 0;

        function logResult(testName, result, message = '') {
            testCount++;
            if (result) passCount++;

            testResults.push({
                name: testName,
                result: result,
                message: message,
                timestamp: new Date().toLocaleTimeString()
            });

            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('testResults');
            let html = `<div class="summary">Tests: ${passCount}/${testCount} passed</div>`;

            testResults.forEach(test => {
                const className = test.result ? 'pass' : 'fail';
                html += `<div class="test-result ${className}">`;
                html += `<strong>${test.timestamp} - ${test.name}:</strong> ${test.result ? 'PASS' : 'FAIL'}`;
                if (test.message) html += ` - ${test.message}`;
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function clearResults() {
            testResults = [];
            testCount = 0;
            passCount = 0;
            updateDisplay();
        }

        function runFullTest() {
            clearResults();
            logResult('Test Suite Started', true, 'Beginning comprehensive testing');

            // Test 1: Data Loading
            testDataLoading();

            // Test 2: DOM Elements
            testDOMElements();

            // Test 3: Tab Switching
            testTabSwitching();

            // Test 4: Statistics
            testStatistics();

            // Test 5: Filtering
            testFiltering();

            // Test 6: Payment Features
            testPaymentFeatures();

            // Test 7: Onboarding Features
            testOnboardingFeatures();

            // Test 8: Local Storage
            testLocalStorage();

            logResult('Test Suite Completed', true, `Final score: ${passCount}/${testCount} tests passed`);
        }

        function testDataLoading() {
            logResult('Data Loading Test', true, 'Starting data validation');

            // Check if fleetData exists
            if (typeof fleetData === 'undefined') {
                logResult('Fleet Data Exists', false, 'fleetData is not defined');
                return;
            }
            logResult('Fleet Data Exists', true);

            // Check riders array
            if (!Array.isArray(fleetData.riders)) {
                logResult('Riders Array', false, 'fleetData.riders is not an array');
                return;
            }
            logResult('Riders Array', true, `Found ${fleetData.riders.length} riders`);

            // Check rider structure
            if (fleetData.riders.length > 0) {
                const firstRider = fleetData.riders[0];
                const requiredFields = ['id', 'name', 'status'];
                const hasRequiredFields = requiredFields.every(field => firstRider.hasOwnProperty(field));

                logResult('Rider Structure', hasRequiredFields, hasRequiredFields ?
                    'Rider has all required fields' : 'Missing required fields');

                // Check specific rider data
                const rider69 = fleetData.riders.find(r => r.id === 69);
                if (rider69) {
                    logResult('Rider 69 Data', true, `Found: ${rider69.name}`);
                } else {
                    logResult('Rider 69 Data', false, 'Rider with ID 69 not found');
                }
            }

            // Check offboarding data
            if (Array.isArray(fleetData.offboarding)) {
                logResult('Offboarding Data', true, `Found ${fleetData.offboarding.length} offboarding records`);
            } else {
                logResult('Offboarding Data', false, 'offboarding is not an array');
            }
        }

        function testDOMElements() {
            logResult('DOM Elements Test', true, 'Checking UI elements');

            // Check main sections
            const sections = ['ridersSection', 'onboardingSection', 'paymentsSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    logResult(`${sectionId} Exists`, true);
                } else {
                    logResult(`${sectionId} Exists`, false, 'Section not found');
                }
            });

            // Check tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            logResult('Tab Buttons', tabButtons.length === 3, `Found ${tabButtons.length} tab buttons`);

            // Check stats elements
            const stats = ['totalRiders', 'activeRiders', 'offboardedRiders', 'newHires'];
            stats.forEach(statId => {
                const stat = document.getElementById(statId);
                if (stat) {
                    logResult(`${statId} Element`, true);
                } else {
                    logResult(`${statId} Element`, false, 'Stat element not found');
                }
            });

            // Check table
            const tableBody = document.getElementById('tableBody');
            if (tableBody) {
                logResult('Riders Table Body', true);
            } else {
                logResult('Riders Table Body', false, 'Table body not found');
            }
        }

        function testTabSwitching() {
            logResult('Tab Switching Test', true, 'Testing navigation');

            // Test initial state
            const ridersSection = document.getElementById('ridersSection');
            const onboardingSection = document.getElementById('onboardingSection');
            const paymentsSection = document.getElementById('paymentsSection');

            if (ridersSection.classList.contains('active')) {
                logResult('Initial Tab State', true, 'Riders tab active by default');
            } else {
                logResult('Initial Tab State', false, 'Riders tab should be active by default');
            }

            // Test tab button clicks
            const onboardingBtn = document.querySelector('[data-tab="onboarding"]');
            const paymentsBtn = document.querySelector('[data-tab="payments"]');
            const ridersBtn = document.querySelector('[data-tab="riders"]');

            if (onboardingBtn) {
                onboardingBtn.click();
                setTimeout(() => {
                    if (onboardingSection.classList.contains('active') &&
                        !ridersSection.classList.contains('active')) {
                        logResult('Onboarding Tab Switch', true);
                    } else {
                        logResult('Onboarding Tab Switch', false, 'Tab did not switch correctly');
                    }
                }, 100);
            }

            if (paymentsBtn) {
                paymentsBtn.click();
                setTimeout(() => {
                    if (paymentsSection.classList.contains('active') &&
                        !onboardingSection.classList.contains('active')) {
                        logResult('Payments Tab Switch', true);
                    } else {
                        logResult('Payments Tab Switch', false, 'Tab did not switch correctly');
                    }
                }, 100);
            }

            // Test payment sub-tabs
            setTimeout(() => {
                const loansBtn = document.getElementById('payTabLoansBtn');
                const txBtn = document.getElementById('payTabTransactionsBtn');

                if (loansBtn) {
                    loansBtn.click();
                    setTimeout(() => {
                        const loansPane = document.getElementById('payLoans');
                        if (loansPane && loansPane.style.display !== 'none') {
                            logResult('Payment Sub-tabs', true, 'Loans sub-tab working');
                        } else {
                            logResult('Payment Sub-tabs', false, 'Loans sub-tab not working');
                        }
                    }, 100);
                }
            }, 200);
        }

        function testStatistics() {
            logResult('Statistics Test', true, 'Testing stat calculations');

            setTimeout(() => {
                const totalRiders = document.getElementById('totalRiders');
                const activeRiders = document.getElementById('activeRiders');
                const offboardedRiders = document.getElementById('offboardedRiders');

                if (totalRiders && totalRiders.textContent) {
                    const total = parseInt(totalRiders.textContent);
                    logResult('Total Riders Stat', total === fleetData.riders.length,
                        `Displayed: ${total}, Expected: ${fleetData.riders.length}`);
                }

                if (activeRiders && activeRiders.textContent) {
                    const active = parseInt(activeRiders.textContent);
                    const expectedActive = fleetData.riders.filter(r => r.status === 'active').length;
                    logResult('Active Riders Stat', active === expectedActive,
                        `Displayed: ${active}, Expected: ${expectedActive}`);
                }

                if (offboardedRiders && offboardedRiders.textContent) {
                    const offboarded = parseInt(offboardedRiders.textContent);
                    const expectedOffboarded = fleetData.riders.filter(r => r.status === 'offboarded').length;
                    logResult('Offboarded Riders Stat', offboarded === expectedOffboarded,
                        `Displayed: ${offboarded}, Expected: ${expectedOffboarded}`);
                }
            }, 500);
        }

        function testFiltering() {
            logResult('Filtering Test', true, 'Testing search and filters');

            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                const tableBody = document.getElementById('tableBody');

                if (searchInput && tableBody) {
                    // Test search
                    const originalRowCount = tableBody.children.length;
                    searchInput.value = 'Muhammad';
                    searchInput.dispatchEvent(new Event('input'));

                    setTimeout(() => {
                        const filteredCount = tableBody.children.length;
                        const expectedCount = fleetData.riders.filter(r =>
                            r.name.toLowerCase().includes('muhammad') ||
                            (r.talabatId && r.talabatId.includes('Muhammad')) ||
                            (r.email && r.email.includes('muhammad'))
                        ).length;

                        logResult('Search Filter', filteredCount === expectedCount,
                            `Filtered: ${filteredCount}, Expected: ${expectedCount}`);

                        // Clear search
                        searchInput.value = '';
                        searchInput.dispatchEvent(new Event('input'));
                    }, 300);
                }

                // Test status filter
                const statusFilter = document.getElementById('statusFilter');
                if (statusFilter) {
                    statusFilter.value = 'active';
                    statusFilter.dispatchEvent(new Event('change'));

                    setTimeout(() => {
                        const activeRows = tableBody.children.length;
                        const expectedActive = fleetData.riders.filter(r => r.status === 'active').length;
                        logResult('Status Filter', activeRows === expectedActive,
                            `Active rows: ${activeRows}, Expected: ${expectedActive}`);

                        // Reset filter
                        statusFilter.value = '';
                        statusFilter.dispatchEvent(new Event('change'));
                    }, 300);
                }
            }, 100);
        }

        function testPaymentFeatures() {
            logResult('Payment Features Test', true, 'Testing payment functionality');

            // Switch to payments tab first
            const paymentsBtn = document.querySelector('[data-tab="payments"]');
            if (paymentsBtn) {
                paymentsBtn.click();

                setTimeout(() => {
                    // Test payment sub-tabs exist
                    const subTabs = ['payTabSettingsBtn', 'payTabProfilesBtn', 'payTabPayrollBtn',
                                   'payTabLoansBtn', 'payTabTransactionsBtn'];

                    subTabs.forEach(tabId => {
                        const tab = document.getElementById(tabId);
                        if (tab) {
                            logResult(`${tabId} Exists`, true);
                        } else {
                            logResult(`${tabId} Exists`, false, 'Payment sub-tab not found');
                        }
                    });

                    // Test settings form
                    const currencyInput = document.getElementById('payCurrency');
                    const startDayInput = document.getElementById('payStartDay');
                    const endDayInput = document.getElementById('payEndDay');

                    if (currencyInput && currencyInput.value === 'AED') {
                        logResult('Payment Settings', true, 'Currency default value correct');
                    } else {
                        logResult('Payment Settings', false, 'Currency default value incorrect');
                    }

                    // Test loan calculation (mock)
                    logResult('Loan Calculation Ready', true, 'EMI calculation functions available');
                }, 200);
            }
        }

        function testOnboardingFeatures() {
            logResult('Onboarding Features Test', true, 'Testing onboarding functionality');

            // Switch to onboarding tab
            const onboardingBtn = document.querySelector('[data-tab="onboarding"]');
            if (onboardingBtn) {
                onboardingBtn.click();

                setTimeout(() => {
                    const obTable = document.getElementById('obTableBody');
                    const addBtn = document.getElementById('addOBBtn');

                    if (obTable) {
                        logResult('Onboarding Table', true, 'Onboarding table exists');
                    } else {
                        logResult('Onboarding Table', false, 'Onboarding table not found');
                    }

                    if (addBtn) {
                        logResult('Add Applicant Button', true, 'Add button exists');
                    } else {
                        logResult('Add Applicant Button', false, 'Add button not found');
                    }

                    // Test filters
                    const obSearch = document.getElementById('obSearch');
                    const obStatusFilter = document.getElementById('obStatusFilter');

                    if (obSearch && obStatusFilter) {
                        logResult('Onboarding Filters', true, 'Search and status filters exist');
                    } else {
                        logResult('Onboarding Filters', false, 'Filters missing');
                    }
                }, 200);
            }
        }

        function testLocalStorage() {
            logResult('Local Storage Test', true, 'Testing data persistence');

            // Test if localStorage is available
            if (typeof Storage !== 'undefined') {
                logResult('LocalStorage Available', true);

                // Test saving data
                try {
                    localStorage.setItem('test_key', 'test_value');
                    const retrieved = localStorage.getItem('test_key');
                    if (retrieved === 'test_value') {
                        logResult('LocalStorage Write/Read', true);
                        localStorage.removeItem('test_key');
                    } else {
                        logResult('LocalStorage Write/Read', false, 'Data not persisted correctly');
                    }
                } catch (e) {
                    logResult('LocalStorage Write/Read', false, `Error: ${e.message}`);
                }

                // Check if app data exists
                const settings = localStorage.getItem('yb_settings');
                if (settings) {
                    logResult('App Settings Persisted', true, 'Payment settings saved');
                } else {
                    logResult('App Settings Persisted', false, 'No settings found in localStorage');
                }

            } else {
                logResult('LocalStorage Available', false, 'localStorage not supported');
            }
        }

        // Auto-run basic checks on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                logResult('Page Load Test', true, 'Page loaded successfully');

                // Quick data check
                if (typeof fleetData !== 'undefined' && fleetData.riders) {
                    logResult('Data Load Test', true, `${fleetData.riders.length} riders loaded`);
                } else {
                    logResult('Data Load Test', false, 'Data not loaded');
                }
            }, 1000);
        });
    </script>
</body>
</html>
